#include "dense.hpp"

#include <catch2/catch_approx.hpp>
#include <catch2/catch_test_macros.hpp>

#include <range/v3/view/all.hpp>
#include <range/v3/view/iota.hpp>

TEST_CASE("Identity")
{
    using namespace ccs;

    std::vector<real> imat{1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
                           0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1};

    std::vector rng{-2.0, -1.0, 0.0, 1.0, 2.0};

    auto mat = matrix::dense{5, 5, imat};

    auto res = mat * rng;

    REQUIRE(res.size() == 5u);

    for (int i = 0; i < 5; i++) REQUIRE(rng[i] == res[i]);
}

TEST_CASE("Non Square1")
{
    using namespace ccs;

    auto coeffs = std::vector{
        83.95087197745517,  54.60811141907641,   -31.02615838268912, -23.749193978143865,
        -47.73731285639923, 68.77294874944397,   -84.32582368924861, -68.68982276024278,
        -66.25620963886223, -14.145795257191367, -20.66243053847711, 26.12372414082023,
        -84.95259217482109, -26.51110805056817,  63.255420433843824, -62.63678283082555,
        -44.15912219148467, 79.63870038246813,   40.13227588220241,  4.250640715510485,
        27.337743054200416, 64.34395968254239,   -49.2229980208256,  -28.064364905871287,
        45.086404615059905, -74.58586464667385,  45.51639082665275,  10.633368817791506,
        27.62738451878431,  -30.951742698251962, 88.544956462669,    99.34593385752356,
        2.3159193728828313, -75.82935876599558,  10.567250113100783};

    auto mat = matrix::dense{5, 7, coeffs};

    auto rhs = std::vector{91.37999616851539,
                           50.64693725996551,
                           -64.60583179621301,
                           -21.187021053699596,
                           61.80093732179881,
                           -51.51860192935814,
                           97.12696476389027};

    auto res = mat * rhs;

    auto exact = std::vector{-1738.7987608832982,
                             -4864.707653579187,
                             8690.006071322056,
                             -1676.9985963825454,
                             -1792.272168705312};

    for (int i = 0; auto&& c : res) {
        REQUIRE(c == Catch::Approx(exact[i]));
        i++;
    }
}

TEST_CASE("Non Square2")
{
    using namespace ccs;

    auto coeffs = std::vector{
        -62.96028312265989, -34.222115425099105, -2.9862605513470157, 23.06985790293345,
        -76.73747513448777, 0.9629408474623347,  -40.620449988213124, -55.87954317817193,
        21.40997482658412,  37.708749410667,     -99.44892107309963,  57.76722097490671,
        -32.31615638733223, -16.107987296727003, 3.2555572175240286,  92.33047063004568,
        -73.78219097339218, -99.4087327368714,   -47.41071272784896,  67.99839324859943,
        -56.75967760541846, -30.570447576312347, -63.39035198957018,  -24.724532373486397,
        43.50746274626897,  24.831628943793476,  -67.23007810345939};

    auto mat = matrix::dense{9, 3, coeffs};

    auto rhs = std::vector{-71.9024502289571, 70.422079255705, -3.7031798936135942};

    auto res = mat * rhs;

    auto exact = std::vector{2128.0647588947263,
                             -7066.357808643435,
                             -1093.7287232110582,
                             -9928.67369062508,
                             1177.1969541409073,
                             -11466.553949160041,
                             8407.725947723382,
                             -2174.430915359314,
                             -1130.6331596949249};

    for (int i = 0; auto&& c : res) {
        REQUIRE(c == Catch::Approx(exact[i]));
        i++;
    }
}
